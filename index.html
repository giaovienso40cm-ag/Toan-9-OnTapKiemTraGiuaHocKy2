<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>To√°n 9 - √în T·∫≠p Gi·ªØa K√¨ II</title>
    <script>
        window.MathJax = {
            tex: { inlineMath: [['$', '$']], processEscapes: true },
            options: { ignoreHtmlClass: 'tex2jax_ignore', processHtmlClass: 'tex2jax_process' }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <style>
        @keyframes blink-warning {
            0% { background-color: #c62828; color: white; transform: scale(1); }
            50% { background-color: #ffeb3b; color: black; transform: scale(1.05); }
            100% { background-color: #c62828; color: white; transform: scale(1); }
        }
        .timer-box {
            font-weight: bold; 
            color: var(--white); 
            background: #2e7d32; 
            padding: 3px 10px; 
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            display: inline-block;
            transition: background 0.3s;
        }
        .timer-warning {
            animation: blink-warning 1s infinite;
        }
        :root {
            --board: #073b31;
            --white: #ffffff;
            --gold: #ffeb3b;
            --wood: #3e2723;
        }

        body {
            background-color: var(--board);
            color: var(--white);
            font-family: 'Times New Roman', serif;
            font-size: 130%; /* ƒêi·ªÅu ch·ªânh font ph√π h·ª£p v·ªõi nhi·ªÅu n·ªôi dung h∆°n */
            margin: 0; padding: 0;
            display: flex; flex-direction: column; align-items: center; min-height: 100vh;
        }

        .persistent-header {
            width: 100%; text-align: center; background: var(--wood); color: var(--gold);
            padding: 15px 0; font-weight: bold; border-bottom: 4px solid #1b1b1b;
            box-shadow: 0 4px 10px rgba(0,0,0,0.4); text-transform: uppercase;
            position: sticky; top: 0; z-index: 1000;
        }

        #quiz-app { width: 100%; max-width: 900px; padding: 25px; box-sizing: border-box; }

        .screen { display: none; }
        .active { display: block; }

        .welcome-box {
            border: 5px double var(--white); padding: 40px; border-radius: 20px;
            background: rgba(255,255,255,0.05); text-align: center;
        }

        input { width: 100%; padding: 15px; font-size: 1.2rem; border-radius: 10px; border: none; margin: 15px 0; box-sizing: border-box; }

        .option {
            border: 2px solid var(--white); padding: 15px 20px; margin: 15px 0;
            border-radius: 12px; cursor: pointer; transition: 0.3s;
            background: rgba(255,255,255,0.1);
        }

        .option:hover {
            background: rgba(255,255,255,0.2); border-color: var(--gold);
            box-shadow: 0 0 20px var(--gold); transform: scale(1.02);
        }

        .correct { background-color: #2e7d32 !important; border-color: #a5d6a7 !important; color: white; }
        .wrong { background-color: #c62828 !important; border-color: #ef9a9a !important; color: white; }

        table { width: 100%; border-collapse: collapse; margin: 20px 0; font-size: 1em; }
        th, td { border: 2px solid var(--white); padding: 12px; text-align: center; }
        .align-left { text-align: left; }
        .tf-cell { cursor: pointer; transition: 0.2s; font-weight: bold; width: 60px; }
        .tf-cell:hover { background: var(--gold); color: #000; }

        .explanation {
            background: #ffffff; color: #000000; padding: 20px; border-radius: 12px;
            margin-top: 20px; display: none; border-left: 10px solid var(--gold); font-size: 1.1rem;
        }

        .btn-action {
            width: 100%;
            padding: 18px; 
            background: var(--gold); 
            color: #000;
            border: none; 
            border-radius: 15px; 
            font-size: 1.4rem; 
            font-weight: bold; 
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
      }

        /* V√¥ hi·ªáu h√≥a hover n·∫øu n√∫t b·ªã disable */
        .btn-action:not(:disabled):hover {
            filter: brightness(1.1); transform: translateY(-3px); box-shadow: 0 8px 15px rgba(0, 0, 0, 0.4);
        }

        .btn-action:not(:disabled):active {
            filter: brightness(0.9); transform: translateY(2px); box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        #music-btn {
            position: fixed; bottom: 20px; right: 20px; z-index: 2000;
            background: var(--gold); border: none; border-radius: 50%; width: 50px; height: 50px;
            cursor: pointer; box-shadow: 0 0 10px rgba(0,0,0,0.5); font-size: 1.5rem;
        }

        .overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85); z-index: 3000; justify-content: center; align-items: center;
        }
        
        .warning-box {
            background: var(--board); border: 3px solid #f44336; padding: 30px; border-radius: 15px;
            text-align: center; color: var(--white); max-width: 80%; box-shadow: 0 0 20px rgba(244, 67, 54, 0.5);
        }
        
        .warning-box h3 { color: #f44336; margin-top: 0; font-size: 1.5rem; }
        .btn-group { display: flex; gap: 15px; justify-content: center; margin-top: 25px; }
        
        .btn-exit { 
            background: #f44336; color: white; border: none; 
            padding: 12px 25px; border-radius: 8px; cursor: pointer; font-size: 1.2rem; font-weight: bold;
        }
    </style>
</head>
<body>

<div class="persistent-header">
    √îN T·∫¨P GI·ªÆA H·ªåC K√å II - TO√ÅN 9
</div>

<button id="music-btn" onclick="toggleMusic()">üéµ</button>

<div id="quiz-app">
    <div id="start-screen" class="screen active">
        <div class="welcome-box">
            <h2 style="color: var(--gold);">CH√ÄO M·ª™NG C√ÅC EM</h2>
            <div style="text-align: left;">
                <label>H·ªç v√† t√™n h·ªçc sinh:</label>
                <input type="text" id="name-in" placeholder="Nh·∫≠p h·ªç t√™n...">
                <label>L·ªõp:</label>
                <input type="text" id="class-in" placeholder="V√≠ d·ª•: 9A1">
            </div>
            <p style="color: #ffb74d; font-size: 1rem; font-style: italic; text-align: center;">Th·ªùi gian l√†m b√†i: 60 ph√∫t</p>
            <button class="btn-action" onclick="startQuiz()">B·∫ÆT ƒê·∫¶U L√ÄM B√ÄI</button>
        </div>
    </div>

    <div id="quiz-screen" class="screen">
       <div style="font-size: 0.9em; color: var(--gold); margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;">
            <span>HS: <span id="u-name"></span> | C√¢u: <span id="q-idx">1</span>/<span id="q-total"></span></span>
            <div id="timer" class="timer-box">‚è± 60:00</div>
        </div>
        <div id="q-txt" style="font-weight: bold; margin-bottom: 20px;"></div>
        <div id="options-box"></div>
        <div id="explain-box" class="explanation"></div>
        <button class="btn-action" id="next-btn" style="display: none; margin-top: 20px;" onclick="goNext()">C√¢u ti·∫øp theo</button>
    </div>

    <div id="result-screen" class="screen">
        <div class="welcome-box">
            <h2 style="color: var(--gold);">K·∫æT QU·∫¢ B√ÄI L√ÄM</h2>
            <p id="final-score" style="font-size: 2.2rem; font-weight: bold;"></p>
            <p id="detail-score" style="font-size: 1.2rem; margin-bottom: 25px; color: #a5d6a7;"></p>
            <!-- ƒê√É TH√äM ID CHO N√öT N√ÄY ƒê·ªÇ ƒêI·ªÄU KHI·ªÇN -->
            <button id="btn-submit-score" class="btn-action" onclick="sendPoints()">N·ªòP B√ÄI L√äN H·ªÜ TH·ªêNG</button>
            
            <button class="btn-action" style="background:#b0bec5; margin-top:15px;" onclick="restartQuiz()">L√ÄM L·∫†I T·ª™ ƒê·∫¶U</button>
            <div id="thanks-note" style="margin-top:30px; color: var(--gold); font-size: 1.2rem; font-weight: bold;"></div>
        </div>
    </div>
</div>

<div id="warning-overlay" class="overlay">
    <div class="warning-box">
        <h3>‚ö†Ô∏è PH√ÅT HI·ªÜN GIAN L·∫¨N!</h3>
        <p style="font-size: 1.2rem;">H·ªá th·ªëng ph√°t hi·ªán em ƒë√£ chuy·ªÉn th·∫ª ho·∫∑c m·ªü ·ª©ng d·ª•ng kh√°c. ƒê·ªÉ ƒë·∫£m b·∫£o t√≠nh c√¥ng b·∫±ng, b√†i l√†m hi·ªán t·∫°i ƒë√£ b·ªã h·ªßy.</p>
        <div class="btn-group">
            <button class="btn-exit" onclick="confirmExit()">L√†m l·∫°i t·ª´ ƒë·∫ßu</button>
        </div>
    </div>
</div>

<audio id="bg-music" loop preload="auto"><source src="nhac-nen.mp3" type="audio/mpeg"></audio>
<audio id="snd-correct" src="dung.mp3" preload="auto"></audio>
<audio id="snd-wrong" src="sai.mp3" preload="auto"></audio>

<script>
    // D√ÅN LINK GOOGLE APPS SCRIPT C·ª¶A B·∫†N V√ÄO ƒê√ÇY
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxfWniDqvX04AKQomqftm5stOjHkRPZfjdK-0SYaCKm6o_lwVU66tPWg1AufTNkLlxP/exec";

    const DB = [
        // --- PH·∫¶N I: TR·∫ÆC NGHI·ªÜM NHI·ªÄU L·ª∞A CH·ªåN ---
        { q: "<b>D·∫°ng 1. Tr·∫Øc nghi·ªám nhi·ªÅu l·ª±a ch·ªçn</b><br><br>C√¢u 1. H√†m s·ªë n√†o sau ƒë√¢y c√≥ d·∫°ng $y=ax^2 \\ (a \\neq 0)$?", a: ["$y=5x-1$", "$y=-7x^2$", "$y=\\frac{4}{x^2}$", "$y=x^3$"], c: 1, e: "H√†m s·ªë b·∫≠c hai c√≥ d·∫°ng $y=ax^2$. Trong c√°c ph∆∞∆°ng √°n, $y=-7x^2$ ƒë√∫ng d·∫°ng v·ªõi $a=-7 \\neq 0$." },
        { q: "C√¢u 2. H√†m s·ªë n√†o sau ƒë√¢y c√≥ d·∫°ng $y=ax^2 \\ (a \\neq 0)$?", a: ["$y=-5x$", "$y=-5x^2$", "$y=x-5$", "$y=\\frac{-5}{x}$"], c: 1, e: "H√†m s·ªë $y=-5x^2$ c√≥ d·∫°ng $y=ax^2$ v·ªõi $a=-5 \\neq 0$." },
        { q: "C√¢u 3. H√†m s·ªë $y=-\\frac{3}{4}x^2$ c√≥ h·ªá s·ªë $a$ b·∫±ng bao nhi√™u?", a: ["$-3$", "$4$", "$-\\frac{3}{4}$", "$\\frac{3}{4}$"], c: 2, e: "H·ªá s·ªë $a$ l√† h·∫±ng s·ªë nh√¢n v·ªõi $x^2$. ·ªû ƒë√¢y $a = -\\frac{3}{4}$." },
        { q: "C√¢u 4. ƒêi·ªÉm n√†o sau ƒë√¢y thu·ªôc ƒë·ªì th·ªã h√†m s·ªë $y=-2x^2$?", a: ["$(1;2)$", "$(-1;-2)$", "$(2;-4)$", "$(0;-2)$"], c: 1, e: "Thay t·ªça ƒë·ªô $(-1;-2)$ v√†o h√†m s·ªë: $-2 = -2(-1)^2 \\Leftrightarrow -2 = -2$ (ƒë√∫ng). V·∫≠y ƒëi·ªÉm $(-1;-2)$ thu·ªôc ƒë·ªì th·ªã." },
        { q: "C√¢u 5. Cho h√†m s·ªë $y=\\frac{1}{2}x^2$. Khi $x=-2$ th√¨ gi√° tr·ªã c·ªßa $y$ l√†:", a: ["$-2$", "$2$", "$4$", "$-4$"], c: 1, e: "Thay $x=-2$ v√†o h√†m s·ªë: $y = \\frac{1}{2}(-2)^2 = \\frac{1}{2} \\cdot 4 = 2$." },
        { q: "C√¢u 6. Cho h√†m s·ªë $y=-3x^2$. Khi $x=-2$ th√¨ gi√° tr·ªã c·ªßa $y$ l√†:", a: ["$12$", "$-12$", "$6$", "$-6$"], c: 1, e: "Thay $x=-2$ v√†o h√†m s·ªë: $y = -3(-2)^2 = -3 \\cdot 4 = -12$." },
        { q: "C√¢u 7. T·ª© gi√°c $EFGH$ n·ªôi ti·∫øp ƒë∆∞·ªùng tr√≤n. Bi·∫øt s·ªë ƒëo g√≥c $\\widehat{E} = 105^\\circ$. S·ªë ƒëo c·ªßa g√≥c ƒë·ªëi di·ªán v·ªõi g√≥c $E$ l√†:", a: ["$75^\\circ$", "$105^\\circ$", "$85^\\circ$", "$180^\\circ$"], c: 0, e: "Trong t·ª© gi√°c n·ªôi ti·∫øp, t·ªïng hai g√≥c ƒë·ªëi di·ªán b·∫±ng $180^\\circ$. G√≥c ƒë·ªëi di·ªán g√≥c $E$ l√† g√≥c $G = 180^\\circ - 105^\\circ = 75^\\circ$." },
        { q: "C√¢u 8. Trong c√°c h√¨nh d∆∞·ªõi ƒë√¢y, h√¨nh n√†o <b>kh√¥ng</b> ƒë·ªìng th·ªùi c√≥ ƒë∆∞·ªùng tr√≤n n·ªôi ti·∫øp v√† ƒë∆∞·ªùng tr√≤n ngo·∫°i ti·∫øp?", a: ["H√¨nh vu√¥ng", "H√¨nh thoi (kh√¥ng c√≥ g√≥c vu√¥ng)", "Tam gi√°c nh·ªçn", "L·ª•c gi√°c ƒë·ªÅu"], c: 1, e: "H√¨nh thoi kh√¥ng c√≥ g√≥c vu√¥ng th√¨ c√≥ ƒë∆∞·ªùng tr√≤n n·ªôi ti·∫øp nh∆∞ng kh√¥ng c√≥ ƒë∆∞·ªùng tr√≤n ngo·∫°i ti·∫øp." },
        { q: "C√¢u 9. H√¨nh n√†o sau ƒë√¢y <b>lu√¥n lu√¥n</b> n·ªôi ti·∫øp ƒë∆∞·ª£c trong m·ªôt ƒë∆∞·ªùng tr√≤n?", a: ["H√¨nh b√¨nh h√†nh", "H√¨nh thoi", "H√¨nh thang c√¢n", "H√¨nh thang vu√¥ng"], c: 2, e: "H√¨nh thang c√¢n lu√¥n n·ªôi ti·∫øp ƒë∆∞·ª£c trong m·ªôt ƒë∆∞·ªùng tr√≤n v√¨ c√≥ t·ªïng hai g√≥c ƒë·ªëi di·ªán b·∫±ng $180^\\circ$." },
        { q: "C√¢u 10. T·ª© gi√°c $PQRS$ n·ªôi ti·∫øp ƒë∆∞·ªùng tr√≤n. T·ªïng s·ªë ƒëo hai g√≥c ƒë·ªëi di·ªán $\\widehat{P}+\\widehat{R}$ b·∫±ng:", a: ["$180^\\circ$", "$360^\\circ$", "$90^\\circ$", "$270^\\circ$"], c: 0, e: "ƒê·ªãnh l√≠: T·ªïng hai g√≥c ƒë·ªëi di·ªán c·ªßa m·ªôt t·ª© gi√°c n·ªôi ti·∫øp b·∫±ng $180^\\circ$." },
        
        // --- PH·∫¶N II: TR·∫ÆC NGHI·ªÜM ƒê√öNG SAI ---
        { 
            q: "<b>D·∫°ng 2. Tr·∫Øc nghi·ªám ƒë√∫ng sai</b><br><br>C√¢u 11. Cho ph∆∞∆°ng tr√¨nh b·∫≠c hai: $x^2-7x+10=0$. Trong m·ªói √Ω a), b), c), d) d∆∞·ªõi ƒë√¢y, h√£y ch·ªçn ƒë√∫ng ho·∫∑c sai:", 
            isTF: true, 
            sub: [
                "a) C√°c h·ªá s·ªë c·ªßa ph∆∞∆°ng tr√¨nh l√† $a=1; b=7; c=10$.", 
                "b) Bi·ªát th·ª©c $\\Delta=(-7)^2-4\\cdot 1\\cdot 10=9$.", 
                "c) Ph∆∞∆°ng tr√¨nh c√≥ nghi·ªám k√©p v√¨ $\\Delta>0$.", 
                "d) Ph∆∞∆°ng tr√¨nh c√≥ hai nghi·ªám ph√¢n bi·ªát l√† $x_1=5$ v√† $x_2=2$."
            ], 
            ans: [false, true, false, true], 
            e: "a) Sai v√¨ $b=-7$. <br>b) ƒê√∫ng. <br>c) Sai, $\\Delta>0$ n√™n PT c√≥ 2 nghi·ªám ph√¢n bi·ªát. <br>d) ƒê√∫ng, v√¨ $5+2=7$ v√† $5\\cdot 2=10$ (Th·ªèa Vi-√©t)." 
        },
        { 
            q: "C√¢u 12. Cho ph∆∞∆°ng tr√¨nh b·∫≠c hai: $2x^2+3x-5=0$. Trong m·ªói √Ω a), b), c), d) d∆∞·ªõi ƒë√¢y, h√£y ch·ªçn ƒë√∫ng ho·∫∑c sai:", 
            isTF: true, 
            sub: [
                "a) C√°c h·ªá s·ªë c·ªßa ph∆∞∆°ng tr√¨nh l√† $a=2; b=3; c=-5$.", 
                "b) T·ªïng c√°c h·ªá s·ªë $a+b+c=0$.", 
                "c) Ph∆∞∆°ng tr√¨nh v√¥ nghi·ªám.", 
                "d) Ph∆∞∆°ng tr√¨nh c√≥ hai nghi·ªám l√† $x_1=1$ v√† $x_2=-\\frac{5}{2}$."
            ], 
            ans: [true, true, false, true], 
            e: "a) ƒê√∫ng. <br>b) ƒê√∫ng ($2+3-5=0$). <br>c) Sai, ph∆∞∆°ng tr√¨nh c√≥ 2 nghi·ªám ph√¢n bi·ªát. <br>d) ƒê√∫ng (Do $a+b+c=0$ n√™n $x_1=1, x_2=\\frac{c}{a}=-\\frac{5}{2}$)." 
        },

        // --- PH·∫¶N III: TR·∫ÆC NGHI·ªÜM TR·∫¢ L·ªúI NG·∫ÆN ---
        { q: "<b>D·∫°ng 3. Tr·∫Øc nghi·ªám tr·∫£ l·ªùi ng·∫Øn</b><br><br>C√¢u 13. G·ªçi $x_1, x_2$ (v·ªõi $x_1>x_2$) l√† hai nghi·ªám c·ªßa ph∆∞∆°ng tr√¨nh $x^2-150x+5000=0$. T√≠nh gi√° tr·ªã c·ªßa bi·ªÉu th·ª©c $A=x_1+2x_2$.", isSA: true, ans: "200", e: "Gi·∫£i PT ta ƒë∆∞·ª£c $x_1=100, x_2=50$. Suy ra $A = 100 + 2(50) = 200$." },
        { q: "C√¢u 14. G·ªçi $x_1, x_2$ (v·ªõi $x_1>x_2$) l√† hai nghi·ªám c·ªßa ph∆∞∆°ng tr√¨nh $x^2-120x+3200=0$. T√≠nh gi√° tr·ªã c·ªßa bi·ªÉu th·ª©c $B=3x_1-x_2$.", isSA: true, ans: "200", e: "Gi·∫£i PT ta ƒë∆∞·ª£c $x_1=80, x_2=40$. Suy ra $B = 3(80) - 40 = 240 - 40 = 200$." },
        { q: "C√¢u 15. Cho b√°t gi√°c ƒë·ªÅu t√¢m $O$. Ph√©p quay t√¢m $O$ theo chi·ªÅu kim ƒë·ªìng h·ªì v·ªõi g√≥c quay nh·ªè nh·∫•t (kh√°c $0^\\circ$) l√† bao nhi√™u ƒë·ªô ƒë·ªÉ bi·∫øn b√°t gi√°c ƒë√≥ th√†nh ch√≠nh n√≥? (Ch·ªâ ƒëi·ªÅn s·ªë ƒëo)", isSA: true, ans: "45", e: "G√≥c quay nh·ªè nh·∫•t ƒë·ªÉ ƒëa gi√°c ƒë·ªÅu $n$ c·∫°nh tr√πng v·ªõi ch√≠nh n√≥ l√† $\\frac{360^\\circ}{n}$. V·ªõi b√°t gi√°c (8 c·∫°nh) l√† $\\frac{360^\\circ}{8} = 45^\\circ$." },
        { q: "C√¢u 16. Cho h√¨nh vu√¥ng $ABCD$ t√¢m $O$ (c√°c ƒë·ªânh ghi th·ª© t·ª± theo chi·ªÅu kim ƒë·ªìng h·ªì). Ph√©p quay t√¢m $O$ thu·∫≠n chi·ªÅu kim ƒë·ªìng h·ªì bi·∫øn ƒë·ªânh $A$ th√†nh ƒë·ªânh $C$ c√≥ s·ªë ƒëo g√≥c quay l√† bao nhi√™u ƒë·ªô? (Ch·ªâ ƒëi·ªÅn s·ªë ƒëo)", isSA: true, ans: "180", e: "$A$ v√† $C$ ƒë·ªëi x·ª©ng qua t√¢m $O$ c·ªßa h√¨nh vu√¥ng, n√™n g√≥c quay bi·∫øn $A$ th√†nh $C$ l√† g√≥c b·∫πt $180^\\circ$." },
        { q: "C√¢u 17. Cho tam gi√°c ƒë·ªÅu $ABC$ t√¢m $O$ (c√°c ƒë·ªânh ghi th·ª© t·ª± ng∆∞·ª£c chi·ªÅu kim ƒë·ªìng h·ªì). ƒê·ªÉ ph√©p quay t√¢m $O$ ng∆∞·ª£c chi·ªÅu kim ƒë·ªìng h·ªì bi·∫øn ƒë·ªânh $A$ th√†nh ƒë·ªânh $C$, ta c·∫ßn th·ª±c hi·ªán m·ªôt g√≥c quay bao nhi√™u ƒë·ªô? (Ch·ªâ ƒëi·ªÅn s·ªë ƒëo)", isSA: true, ans: "240", e: "C√°c ƒë·ªânh $A, B, C$ x·∫øp ng∆∞·ª£c chi·ªÅu kim ƒë·ªìng h·ªì. Quay t√¢m O t·ª´ $A$ ƒë·∫øn $B$ l√† $120^\\circ$, t·ª´ $B$ ƒë·∫øn $C$ l√† $120^\\circ$. V·∫≠y g√≥c quay ng∆∞·ª£c chi·ªÅu kim ƒë·ªìng h·ªì t·ª´ $A$ th√†nh $C$ l√† $120^\\circ+120^\\circ = 240^\\circ$." }
    ];

    let curr = 0;
    let rawScore = 0; 
    let retries = 0;
    let sN = "", sC = "";
     let isSubmitting = false; // BI·∫æN C·ªú ƒê·ªÇ KH√ìA N√öT N·ªòP B√ÄI
    const MAX_RAW_SCORE = 23; // 10 (MC) + 8 (TF) + 5 (SA)
    
    // --- TIMER ---
    let timerInterval;
    let timeLeft = 3600; // 60 ph√∫t = 3600 gi√¢y

    function startTimer() {
        timeLeft = 3600;
        document.getElementById('timer').classList.remove('timer-warning');
        document.getElementById('timer').style.background = "#2e7d32";
        
        clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            timeLeft--;
            let m = Math.floor(timeLeft / 60);
            let s = timeLeft % 60;
            document.getElementById('timer').innerText = `‚è± ${m < 10 ? '0'+m : m}:${s < 10 ? '0'+s : s}`;
            
            if(timeLeft <= 300) { // C·∫£nh b√°o d∆∞·ªõi 5 ph√∫t
                document.getElementById('timer').classList.add('timer-warning');
            }
            if(timeLeft <= 0) {
                clearInterval(timerInterval);
                document.getElementById('timer').innerText = "‚è± 00:00";
                alert("ƒê√£ h·∫øt th·ªùi gian l√†m b√†i! H·ªá th·ªëng t·ª± ƒë·ªông thu b√†i.");
                end();
            }
        }, 1000);
    }

    function toggleMusic() {
        const m = document.getElementById('bg-music');
        const b = document.getElementById('music-btn');
        if (m.paused) { m.play(); b.innerText = "üîá"; }
        else { m.pause(); b.innerText = "üéµ"; }
    }

    function startQuiz() {
        sN = document.getElementById('name-in').value.trim();
        sC = document.getElementById('class-in').value.trim();
        if(!sN || !sC) return alert("Nh·∫≠p ƒë·ªß th√¥ng tin h·ªç t√™n v√† l·ªõp em nh√©!");
        
        const m = document.getElementById('bg-music');
        m.play().catch(() => console.log("Ch·∫∑n ph√°t nh·∫°c"));
        document.getElementById('music-btn').innerText = "üîá";

        document.getElementById('u-name').innerText = sN;
        document.getElementById('q-total').innerText = DB.length;
        document.getElementById('start-screen').classList.remove('active');
        document.getElementById('quiz-screen').classList.add('active');
        
        startTimer();
        render();
    }

    function render() {
        const item = DB[curr];
        document.getElementById('q-idx').innerText = curr + 1;
        document.getElementById('explain-box').style.display = 'none';
        document.getElementById('next-btn').style.display = 'none';
        document.getElementById('q-txt').innerHTML = item.q;
        
        const box = document.getElementById('options-box');
        box.innerHTML = "";
        
        if (item.isTF) {
            let table = `<table><tr><th>Ph√°t bi·ªÉu</th><th>ƒê√∫ng</th><th>Sai</th></tr>`;
            item.sub.forEach((txt, i) => {
                table += `<tr><td class="align-left">${txt}</td><td class="tf-cell" onclick="checkTF(${i}, true, this)">ƒê</td><td class="tf-cell" onclick="checkTF(${i}, false, this)">S</td></tr>`;
            });
            box.innerHTML = table + `</table>`;
        } else if (item.isSA) {
            box.innerHTML = `
                <div style="margin-top:20px;">
                    <input type="text" id="sa-input" placeholder="Nh·∫≠p ƒë√°p √°n c·ªßa em (ghi s·ªë)..." style="width: 100%; color: black; font-weight: bold; text-align: center;">
                    <button class="btn-action" style="margin-top: 15px;" id="btn-submit-sa" onclick="checkSA(this)">KI·ªÇM TRA ƒê√ÅP √ÅN</button>
                </div>
            `;
        } else {
            const labels = ['A','B','C','D'];
            item.a.forEach((txt, i) => {
                const d = document.createElement('div');
                d.className = 'option';
                d.innerHTML = `<strong>${labels[i]}.</strong> ${txt}`;
                d.onclick = () => checkMC(i, d);
                box.appendChild(d);
            });
        }
        MathJax.typesetPromise();
    }

    function checkMC(idx, el) {
        const item = DB[curr];
        const all = document.querySelectorAll('.option');
        all.forEach(o => o.style.pointerEvents = 'none'); 
        
        if(idx === item.c) {
            el.classList.add('correct');
            document.getElementById('snd-correct').play();
            rawScore += 1; // 1 ƒëi·ªÉm cho 1 c√¢u TN
        } else {
            el.classList.add('wrong');
            all[item.c].classList.add('correct');
            document.getElementById('snd-wrong').play();
            const exp = document.getElementById('explain-box');
            exp.innerHTML = `<strong>Gi·∫£i th√≠ch:</strong> ${item.e}`;
            exp.style.display = 'block';
            MathJax.typesetPromise();
        }
        document.getElementById('next-btn').style.display = 'block';
    }

    function checkTF(row, choice, el) {
        const item = DB[curr];
        const tr = el.parentElement;
        if(tr.dataset.done) return;
        tr.dataset.done = "true";
        
        const isCorrect = (choice === item.ans[row]);
        el.style.background = isCorrect ? "#2e7d32" : "#c62828";
        el.style.color = "#fff";
        
        if(isCorrect) { 
            rawScore += 1; // 1 ƒëi·ªÉm th√¥ cho m·ªói √Ω ƒë√∫ng
            document.getElementById('snd-correct').play(); 
        } else {
            document.getElementById('snd-wrong').play();
        }
        
        if(document.querySelectorAll('[data-done]').length === item.sub.length) {
            const exp = document.getElementById('explain-box');
            exp.innerHTML = `<strong>Gi·∫£i th√≠ch:</strong><br>${item.e}`;
            exp.style.display = 'block';
            MathJax.typesetPromise();
            document.getElementById('next-btn').style.display = "block";
        }
    }

    function checkSA(btn) {
        const item = DB[curr];
        const inp = document.getElementById('sa-input');
        const val = inp.value.trim().toLowerCase();
        
        if(val === "") {
            alert("Em h√£y nh·∫≠p ƒë√°p √°n tr∆∞·ªõc khi ki·ªÉm tra nh√©!");
            return;
        }
        
        inp.disabled = true;
        btn.style.display = 'none';
        
        if(val === item.ans.toLowerCase()) {
            inp.style.background = "#a5d6a7";
            document.getElementById('snd-correct').play();
            rawScore += 1; // 1 ƒëi·ªÉm th√¥ cho tr·∫£ l·ªùi ng·∫Øn ƒë√∫ng
        } else {
            inp.style.background = "#ef9a9a";
            document.getElementById('snd-wrong').play();
            const exp = document.getElementById('explain-box');
            exp.innerHTML = `<strong>ƒê√°p √°n ƒë√∫ng:</strong> ${item.ans}<br><strong>Gi·∫£i th√≠ch:</strong> ${item.e}`;
            exp.style.display = 'block';
            MathJax.typesetPromise();
        }
        document.getElementById('next-btn').style.display = 'block';
    }

    function goNext() {
        curr++;
        if(curr < DB.length) render();
        else end();
    }

    function end() {
        clearInterval(timerInterval);
        document.getElementById('quiz-screen').classList.remove('active');
        document.getElementById('result-screen').classList.add('active');
        
        // Quy ƒë·ªïi ra thang ƒëi·ªÉm 10
        let finalScoreScale10 = (rawScore / MAX_RAW_SCORE) * 10;
        finalScoreScale10 = Math.round(finalScoreScale10 * 10) / 10; // L√†m tr√≤n 1 ch·ªØ s·ªë th·∫≠p ph√¢n
        
        document.getElementById('final-score').innerText = `${finalScoreScale10} / 10 ƒêi·ªÉm`;
        document.getElementById('detail-score').innerText = `(ƒê·∫°t ${rawScore}/${MAX_RAW_SCORE} √Ω ƒë√∫ng)`;
    }

     // --- H√ÄM G·ª¨I ƒêI·ªÇM ƒê√É ƒê∆Ø·ª¢C CH·ªêNG SPAM (DEBOUNCE) ---
    function sendPoints() {
        // N·∫øu ƒëang trong qu√° tr√¨nh n·ªôp th√¨ ch·∫∑n kh√¥ng cho ch·∫°y l·ªánh ph√≠a d∆∞·ªõi
        if (isSubmitting) return; 

        const btnSubmit = document.getElementById('btn-submit-score');
        const thanksNote = document.getElementById('thanks-note');

        // B·∫≠t c·ªù kh√≥a n√∫t
        isSubmitting = true; 
        
        // ƒê·ªïi giao di·ªán n√∫t ƒë·ªÉ h·ªçc sinh bi·∫øt l√† h·ªá th·ªëng ƒëang x·ª≠ l√Ω
        btnSubmit.innerText = "ƒêANG N·ªòP B√ÄI... VUI L√íNG CH·ªú";
        btnSubmit.style.opacity = "0.7";
        btnSubmit.style.cursor = "not-allowed";
        btnSubmit.disabled = true; // Kh√≥a h·∫≥n n√∫t b·∫•m tr√™n HTML

        if(SCRIPT_URL.includes("D√ÅN_LINK")) {
            // Hi·ªáu ·ª©ng khi ch∆∞a d√°n link th·∫≠t
            setTimeout(() => {
                btnSubmit.innerText = "ƒê√É N·ªòP B√ÄI TH√ÄNH C√îNG";
                btnSubmit.style.background = "#4caf50";
                btnSubmit.style.color = "white";
                thanksNote.innerText = "Em l√†m t·ªët l·∫Øm. Th·∫ßy/C√¥ ƒë√£ nh·∫≠n ƒë∆∞·ª£c b√†i c·ªßa em";
            }, 1000);
            return;
        }
        
        const tenTrangTinh = "GiuaKy2_Toan9"; 
        let finalScoreScale10 = Math.round((rawScore / MAX_RAW_SCORE) * 10 * 10) / 10;

        fetch(SCRIPT_URL, { 
            method: 'POST', 
            mode: 'no-cors', 
            body: JSON.stringify({
                s: tenTrangTinh, 
                n: sN, 
                c: sC, 
                d: finalScoreScale10, 
                r: retries
            }) 
        })
        .then(() => {
            // Khi n·ªôp th√†nh c√¥ng
            btnSubmit.innerText = "ƒê√É N·ªòP B√ÄI TH√ÄNH C√îNG";
            btnSubmit.style.background = "#4caf50"; // ƒê·ªïi sang m√†u xanh l√°
            btnSubmit.style.color = "white";
            thanksNote.innerText = "Em l√†m t·ªët l·∫Øm. Th·∫ßy/C√¥ ƒë√£ nh·∫≠n ƒë∆∞·ª£c b√†i c·ªßa em";
        })
        .catch(() => {
            // L·ªói m·∫°ng, m·ªü kh√≥a n√∫t cho h·ªçc sinh n·ªôp l·∫°i
            alert("C√≥ l·ªói k·∫øt n·ªëi m·∫°ng. Em vui l√≤ng b·∫•m n·ªôp l·∫°i nh√©!");
            isSubmitting = false;
            btnSubmit.innerText = "N·ªòP L·∫†I B√ÄI";
            btnSubmit.style.opacity = "1";
            btnSubmit.style.cursor = "pointer";
            btnSubmit.disabled = false;
        });
    }

    function restartQuiz() {
        curr = 0; rawScore = 0; retries++;
        
        // --- RESET L·∫†I TR·∫†NG TH√ÅI N√öT N·ªòP B√ÄI KHI L√ÄM L·∫†I T·ª™ ƒê·∫¶U ---
        isSubmitting = false;
        const btnSubmit = document.getElementById('btn-submit-score');
        btnSubmit.innerText = "N·ªòP B√ÄI L√äN H·ªÜ TH·ªêNG";
        btnSubmit.style.background = "var(--gold)";
        btnSubmit.style.color = "#000";
        btnSubmit.style.opacity = "1";
        btnSubmit.style.cursor = "pointer";
        btnSubmit.disabled = false;
        // -------------------------------------------------------------

        document.getElementById('result-screen').classList.remove('active');
        document.getElementById('quiz-screen').classList.add('active');
        document.getElementById('thanks-note').innerText = "";
        startTimer();
        render();
    }

    // --- ANTI CHEAT ---
    document.addEventListener("visibilitychange", function() {
        const quizScreen = document.getElementById('quiz-screen');
        if (document.hidden && quizScreen.classList.contains('active')) {
            document.getElementById('warning-overlay').style.display = 'flex';
            document.getElementById('q-txt').style.opacity = '0'; 
            document.getElementById('options-box').style.opacity = '0';
        }
    });

    function confirmExit() {
        document.getElementById('warning-overlay').style.display = 'none';
        document.getElementById('q-txt').style.opacity = '1'; 
        document.getElementById('options-box').style.opacity = '1';
        restartQuiz(); 
    }
</script>
</body>
</html>



